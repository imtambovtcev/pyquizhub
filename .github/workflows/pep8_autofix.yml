name: PEP8 Auto-fix via PR

on:
  push:
    branches:
      - main
    paths:
      - '**/*.py'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-format
  cancel-in-progress: false

jobs:
  autofix-formatting:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install autopep8
        run: pip install autopep8

      # Run the formatter directly on the workspace (currently on main)
      - name: Auto-fix formatting
        run: |
          FILES=$(git ls-files '*.py')
          if [ -z "$FILES" ]; then
            echo "No Python files tracked."
            exit 0
          fi
          echo "Auto-fixing formatting..."
          for file in $FILES; do
            autopep8 --in-place --aggressive --aggressive "$file"
          done

      # Only proceed if there are changes after formatting
      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # Let the action create/update the branch and PR. We do NOT push ourselves.
      - name: Create or update PR with formatting changes
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-format              # fixed branch so PR is updated each run
          base: main
          title: "style: automated PEP8 formatting"
          body: |
            This PR applies automated PEP8 formatting fixes.
            - Tool: autopep8 (aggressive x2)
            - Trigger: push to main affecting *.py
          commit-message: "style: auto-fix PEP8 formatting"
          committer: GitHub <noreply@github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          signoff: false
          draft: false
          delete-branch: false
