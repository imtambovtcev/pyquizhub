{% extends "base.html" %}

{% block title %}Admin Dashboard - PyQuizHub{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Admin Dashboard</h2>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Quizzes</h3>
            <p class="stat-number" id="quiz-count">-</p>
        </div>
        <div class="stat-card">
            <h3>Active Tokens</h3>
            <p class="stat-number" id="token-count">-</p>
        </div>
        <div class="stat-card">
            <h3>Total Users</h3>
            <p class="stat-number" id="user-count">-</p>
        </div>
        <div class="stat-card">
            <h3>Active Sessions</h3>
            <p class="stat-number" id="session-count">-</p>
        </div>
    </div>

    <div class="quick-actions">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
            <a href="/quiz/create" class="btn btn-primary">Create New Quiz</a>
            <a href="/quizzes" class="btn btn-secondary">Manage Quizzes</a>
            <a href="/tokens" class="btn btn-secondary">Manage Tokens</a>
            <a href="/results" class="btn btn-secondary">View Results</a>
        </div>
    </div>

    <div class="system-status">
        <h3>System Status</h3>
        <div id="status-display">
            <p><strong>Admin Web:</strong> <span id="admin-status" class="status-indicator">Checking...</span></p>
            <p><strong>API Connection:</strong> <span id="api-status" class="status-indicator">Checking...</span></p>
            <p><strong>API URL:</strong> <span id="api-url">-</span></p>
        </div>
    </div>

    <div class="adapters-status">
        <h3>Adapters Status</h3>
        <div id="adapters-display" class="adapters-grid">
            <div class="adapter-card">
                <h4>CLI Adapter</h4>
                <p class="adapter-status" id="cli-status">Checking...</p>
                <p class="adapter-description" id="cli-description">-</p>
            </div>
            <div class="adapter-card">
                <h4>Web Adapter</h4>
                <p class="adapter-status" id="web-status">Checking...</p>
                <p class="adapter-description" id="web-description">-</p>
            </div>
            <div class="adapter-card">
                <h4>Telegram Bot</h4>
                <p class="adapter-status" id="telegram-status">Checking...</p>
                <p class="adapter-description" id="telegram-description">-</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load dashboard stats
async function loadDashboardStats() {
    try {
        // Load quizzes
        const quizzesRes = await fetch('/api/quizzes');
        const quizzes = await quizzesRes.json();
        document.getElementById('quiz-count').textContent = 
            Object.keys(quizzes.quizzes || {}).length;

        // Load tokens
        const tokensRes = await fetch('/api/tokens');
        const tokens = await tokensRes.json();
        let tokenCount = 0;
        Object.values(tokens.tokens || {}).forEach(arr => tokenCount += arr.length);
        document.getElementById('token-count').textContent = tokenCount;

        // Load users
        const usersRes = await fetch('/api/users');
        const users = await usersRes.json();
        document.getElementById('user-count').textContent = 
            Object.keys(users.users || {}).length;

        // Load sessions
        const sessionsRes = await fetch('/api/sessions');
        const sessions = await sessionsRes.json();
        let sessionCount = 0;
        Object.values(sessions.sessions || {}).forEach(arr => sessionCount += arr.length);
        document.getElementById('session-count').textContent = sessionCount;

    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        showMessage('Error loading statistics', 'error');
    }
}

// Check system health
async function checkHealth() {
    try {
        const res = await fetch('/api/health');
        const health = await res.json();

        document.getElementById('admin-status').textContent = '✓ Healthy';
        document.getElementById('admin-status').className = 'status-indicator status-healthy';

        if (health.api_connection === 'healthy') {
            document.getElementById('api-status').textContent = '✓ Connected';
            document.getElementById('api-status').className = 'status-indicator status-healthy';
        } else {
            document.getElementById('api-status').textContent = '✗ Disconnected';
            document.getElementById('api-status').className = 'status-indicator status-error';
        }

        document.getElementById('api-url').textContent = health.api_url || 'Unknown';
    } catch (error) {
        console.error('Health check failed:', error);
        document.getElementById('admin-status').textContent = '✗ Error';
        document.getElementById('admin-status').className = 'status-indicator status-error';
    }
}

// Check adapters status
async function checkAdaptersStatus() {
    try {
        const res = await fetch('/api/adapters/status');
        const data = await res.json();
        const adapters = data.adapters;

        // Update CLI adapter
        if (adapters.cli) {
            const cliStatus = document.getElementById('cli-status');
            cliStatus.textContent = '✓ Available';
            cliStatus.className = 'adapter-status status-healthy';
            document.getElementById('cli-description').textContent = adapters.cli.description;
        }

        // Update Web adapter
        if (adapters.web) {
            const webStatus = document.getElementById('web-status');
            if (adapters.web.status === 'running') {
                webStatus.textContent = '✓ Running';
                webStatus.className = 'adapter-status status-healthy';
            } else if (adapters.web.status === 'stopped') {
                webStatus.textContent = '✗ Stopped';
                webStatus.className = 'adapter-status status-error';
            } else {
                webStatus.textContent = '⚠ Error';
                webStatus.className = 'adapter-status status-warning';
            }
            document.getElementById('web-description').textContent = adapters.web.description;
        }

        // Update Telegram adapter
        if (adapters.telegram) {
            const telegramStatus = document.getElementById('telegram-status');
            if (adapters.telegram.status === 'running') {
                telegramStatus.textContent = '✓ Running';
                telegramStatus.className = 'adapter-status status-healthy';
            } else if (adapters.telegram.status === 'not_configured') {
                telegramStatus.textContent = '○ Not Configured';
                telegramStatus.className = 'adapter-status status-warning';
            } else {
                telegramStatus.textContent = '✗ Stopped';
                telegramStatus.className = 'adapter-status status-error';
            }
            document.getElementById('telegram-description').textContent = adapters.telegram.description;
        }
    } catch (error) {
        console.error('Adapters status check failed:', error);
        document.getElementById('cli-status').textContent = '✗ Error';
        document.getElementById('web-status').textContent = '✗ Error';
        document.getElementById('telegram-status').textContent = '✗ Error';
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardStats();
    checkHealth();
    checkAdaptersStatus();

    // Refresh stats every 30 seconds
    setInterval(loadDashboardStats, 30000);
    setInterval(checkHealth, 60000);
    setInterval(checkAdaptersStatus, 60000);
});
</script>
{% endblock %}
